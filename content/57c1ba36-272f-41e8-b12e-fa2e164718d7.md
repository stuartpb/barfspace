# Gearing Up for a Real Cluster

Okay, so, having had Studtop fall apart after trying to roll out OpenEBS a few times now, I've gone back to the drawing board.

My new plan:

- Remake Studtop (again) using a keypair for root that will be kept on the Ignition disk.
  - Studtop itself will not be set up for ignition at this time.
  - openiscsid and e2fsrogs will NOT be installed.
  - run `kubeadm init` and note down the join info, and copy theconfig stuff appropriately
  - DON'T untaint the master node
    - we will actually leave studtop as a dedicated manager
- Flash router with OpenWRT and port all the DHCP assignments over (and add hostname suggestions?)
  - This might still have to wait a bit
- Add Pi 4 as `studrang`
  - possibly companion to a future `sturmund`
    - which might be the Rpi3A that replaces the 0 in Stuworks
    - or might just be a twin unit
      - in which case the one in the printer is called what?
        - stuphaestus
          - stufesto might be cool tho
            - oh dang, hephaestus might not be a bad alternative branding to printacle
  - Add label `st8s.stuartpb.com/storage-cluster=rook-ceph` or something like that
    - this will be the selector for "every unpartitioned disk plugged into this will be Borged into this system of cluster storage"
    - so like, another label might be devised to dedicate a node to devices for a non-Rook-Ceph storage solution
        - but I'm cool thinking of it at a node level
          - it just says what kind of storage the node has on it - not that the node's a dedicated storage node
- plug the HDD, unpartitioned PNY, and Ignition stick (with proper hostname to set up) into the Pi

## Why Ditch OpenEBS for Rook?

I wanted to do Rook in the first place, but I couldn't figure out where to start (maybe because I couldn't understand operators initially, idk). There are old notes about this

I didn't quite get it? but now I do, I get Rook, and furthermore, I get how lots of apps are going to want Buckets, and how smooth Rook configuring Ceph from Kubernetes (and potentially other things than Ceph, though Ceph looks best) will make having that (over EBS which really was very low-level)

Kubic comes with what looks like all Rook's example manifests pre-installed and presumably converted for openSUSE-backed images (though ofc I'm going with the stubernetes-system approach), so it's well-vetted and supported for Kubic. Meanwhile, nmot only is running open-iscsid at the host level not very Kubic, the installer explicitly reminds me that it's "unsupported" (though, like, so is Wicked).

Rook has documentation shortcomings, but it's built on an old and well-contributed to base tech (ie Ceph), and not three-new-drivers-we-each-made-just-for-this like OpenEBS

## Why bring in the Pi now?

Honestly:

- it's more powerful (quad-core, right?)
- I want storage, and I trust its firmware USB3 handling better
- I saw just how ugly things get when the coordinator is not on a dedicated node
- stuff can get moved to the Chromebook as needed
  - like, I'll probably add tolerations to most system services
    - this does suggest I might *change* its toleration to not be like "master-node"
    - I might even just remove that taint, but only after getting the two-node cluster going

## stuff I verified first

- Ceph has a concept of device class that matches what we want pretty directly
- Ceph works on ARM

## anyway here we go again

sshing in and running `curl -L https://download.opensuse.org/tumbleweed/iso/openSUSE-Kubic-DVD-x86_64-Current.iso | dd of=/dev/mmcblk0` to get our install media up to date

the plan:

- reinstall completely normally
  - add SSH key of newly-generated keypair kept on ignition stick only as authorized key for root account
- log in using said key
- change hostname, change logind.conf manually, see if `transactional-update` does anything and restart
  - if I can change the hostname cleanly in installation I might just reload systemd-logind instead of update/restarting the system
- `kubeadm init` and gank the new config locally
  - not gonna even bother copying to the root user on the host any more
- install stubernetes-core to initialize weave and prepare helm-operator to deploy when ready
- initialize the Pi 4 with Ignition key in it
- figure out giving it a DHCP reservation etc or whatever so its IP matches DNS
- `kubeadm join`
- ensure the Helm Operator is scheduled once that's done
- start deploying stubernetes-system to the Pi as a worker

## execution

went through setup:

- setup had a UI problem with the SSH key having no label; while this should be fixed upstream, the fix locally is that this should always have a "stuart@stubernetes" memo at the end on the pubkey
- ssh failed to log in with a key that was 0644 and not `chmod 600 id_rsa` - I don't think I can make my Chrome app set permissions, but it'd be cool if I could

## diversion after setting hostname

When editing logind.conf

I decide that, actually, this time, I want to leave `HandleLidSwitch=suspend` *on*. In general, we're gonna be governed by `HandleLidSwitchExternalPower=ignore`, and you know what? if I'm resorting to battery, I *want* to be able to suspend the system by closing the lid (so long as removing power doesn't retroactively trigger a suspension).

otoh... can't I just do a manual `powerctl suspend` or something like that? and closing the lid won't wake the system?

screw it, let's not rock the boat now. I'll set both to `ignore`.

## back to it

after setting the hostname with hostnamectl and exiting and reentering, I do `systemctl restart systemd-logind`

transactional-update did nothing

gonna go ahead and `kubeadm init` now

## uhh wtf

```
W0702 01:38:52.470237    3026 configset.go:202] WARNING: kubeadm cannot validate component configs for API groups [kubelet.config.k8s.io kubeproxy.config.k8s.io]
[init] Using Kubernetes version: v1.18.3
[preflight] Running pre-flight checks
[preflight] Pulling images required for setting up a Kubernetes cluster
[preflight] This might take a minute or two, depending on the speed of your internet connection
[preflight] You can also perform this action in beforehand using 'kubeadm config images pull'
error execution phase preflight: [preflight] Some fatal errors occurred:
	[ERROR ImagePull]: failed to pull image registry.opensuse.org/kubic/kube-apiserver:v1.18.3: output: time="2020-07-02T01:39:07Z" level=fatal msg="pulling image failed: rpc error: code = Unknown desc = Error choosing image instance: no image found in manifest list for architecture amd64, variant \"\", OS linux"
, error: exit status 1
	[ERROR ImagePull]: failed to pull image registry.opensuse.org/kubic/kube-controller-manager:v1.18.3: output: time="2020-07-02T01:39:13Z" level=fatal msg="pulling image failed: rpc error: code = Unknown desc = Error choosing image instance: no image found in manifest list for architecture amd64, variant \"\", OS linux"
, error: exit status 1
	[ERROR ImagePull]: failed to pull image registry.opensuse.org/kubic/kube-scheduler:v1.18.3: output: time="2020-07-02T01:39:18Z" level=fatal msg="pulling image failed: rpc error: code = Unknown desc = Error choosing image instance: no image found in manifest list for architecture amd64, variant \"\", OS linux"
, error: exit status 1
	[ERROR ImagePull]: failed to pull image registry.opensuse.org/kubic/kube-proxy:v1.18.3: output: time="2020-07-02T01:39:23Z" level=fatal msg="pulling image failed: rpc error: code = Unknown desc = Error choosing image instance: no image found in manifest list for architecture amd64, variant \"\", OS linux"
, error: exit status 1
[preflight] If you know what you are doing, you can make a check non-fatal with `--ignore-preflight-errors=...`
To see the stack trace of this error execute with --v=5 or higher
```

... let's try the old "turning it off and back on again"

## okay, so, now

trying `kubeadm init` again I back out quick because, once again, the transient hostname has become just "studtop"

anyway, I got the same problem.. not sure what's up, but it seems to be trying to init one version behind what they're packaging upstream. `kubeadm init --kubernetes-version v1.18.4`

```
[apiclient] All control plane components are healthy after 54.014566 seconds
[upload-config] Storing the configuration used in ConfigMap "kubeadm-config" in the "kube-system" Namespace
[kubelet] Creating a ConfigMap "kubelet-config-1.18" in namespace kube-system with the configuration for the kubelets in the cluster
[upload-certs] Skipping phase. Please see --upload-certs
[mark-control-plane] Marking the node studtop.nodes.403.stuartpb.com as control-plane by adding the label "node-role.kubernetes.io/master=''"
[mark-control-plane] Marking the node studtop.nodes.403.stuartpb.com as control-plane by adding the taints [node-role.kubernetes.io/master:NoSchedule]
[bootstrap-token] Using token: (nice try wise guy)
[bootstrap-token] Configuring bootstrap tokens, cluster-info ConfigMap, RBAC Roles
[bootstrap-token] configured RBAC rules to allow Node Bootstrap tokens to get nodes
[bootstrap-token] configured RBAC rules to allow Node Bootstrap tokens to post CSRs in order for nodes to get long term certificate credentials
[bootstrap-token] configured RBAC rules to allow the csrapprover controller automatically approve CSRs from a Node Bootstrap Token
[bootstrap-token] configured RBAC rules to allow certificate rotation for all node client certificates in the cluster
[bootstrap-token] Creating the "cluster-info" ConfigMap in the "kube-public" namespace
[kubelet-finalize] Updating "/etc/kubernetes/kubelet.conf" to point to a rotatable kubelet client certificate and key
[addons] Applied essential addon: CoreDNS
[addons] Applied essential addon: kube-proxy
```

going ahead and grabbing the admin values out of /etc/kubernetes/admin.conf as well as copying down the kubeadm join lines

## the one command for studtop

first I `kubectl create ns stubernetes-system`

then (from the stubernetes-core work tree) `helm install -n stubernetes-system stubernetes-core .`

## it is time

I plug everything into the Pi, both USB drives and the Ignition stick and the MicroSD card and the Ethernet cable, then power...

and I don't see it on the network

I could probably break out the TTL to diagnose this, but I feel like using a little HDMI screen instead

Anyway, I've ordered that, it's on its way for tomorrow.

My plot now is to get ready to put OpenWRT on the router

## well, whatever

just installed `wireshark-qt` to Stushiba, just in case

Anyway, hooked up the screen, and got a phone-camera screenshot of the error I was having with build 78, which looks like of like what I was running to with Build 81

But [kukuk's personal repo](https://download.opensuse.org/repositories/home:/kukuk:/raspi:/images/openSUSE_Factory_ARM/) has a build from March, and that has some different errors, and looks more like something I'll be able to set up and update

One thing I make out from the opening spew when I try to boot is that our 3.1.0 Ignition isn't supported, so I manually edit the one in the disk to 3.0.0 and try again

The non-embedded-keys version failed as you might expect, but adding all my keys as data URLs worked (so it could bring up the network after)

after associating to the network, I add a DHCP reservation for it, then unplug the ethernet cable and reattach to jiggle the IP. The screen resets and I can see that it's all good

Okay, so, I can connect to the SSH server, but it doesn't seem to recognize my key?

Looks like I might need to take a different approach for setting up root's authorized keys

Rewriting Ignition and trying again

I can't figure out how to edit boot params to make it try reading Ignition again, so, fuck it, reflashing

After making sure the Ignition file was valid... hmm, it's not there. Screw it, I'll figure it out some other time. I pull out the MicroSD, plug it into Stushiba, and:

```
sudo mount /dev/disk/by-uuid/d90158e4-8c9b-4fa7-a2a8-907fc3a5b0ca -o noatime,subvol=@/root /mnt
sudo mkdir -p /mnt/.ssh
sudo bash -c 'curl https://github.com/stuartpb.keys > /mnt/.ssh/authorized_keys'
sudo chmod 0600 /mnt/.ssh/authorized_keys
sudo umount /mnt
```

## and we're in

set-hostname done

running `transactional-update dup --interactive`

```
Checking for newer version.
New version found - updating...
Loading repository data...
Reading installed packages...
Retrieving package transactional-update-2.22-1.1.aarch64                                                                                                                   (1/1),  60.5 KiB (151.9 KiB unpacked)
(1/1) /tmp/transactional-update.Eo9BjtTjIg/repo-oss/aarch64/transactional-update-2.22-1.1.aarch64.rpm ....................................................................................................[done]
transactional-update 2.22 started
Options: dup --interactive
Separate /var detected.
/etc on overlayfs detected.
Calling zypper --no-cd dup
Loading repository data...
Reading installed packages...
Warning: You are about to do a distribution upgrade with all enabled repositories. Make sure these repositories are compatible before you continue. See 'man zypper' for more information about this command.
Computing distribution upgrade...
9 Problems:
Problem: problem with installed package kubic-haproxycfg-0.10.0-44.12.aarch64
Problem: problem with installed package kubicctl-0.10.0-44.12.aarch64
Problem: problem with installed package kubicd-0.10.0-44.12.aarch64
Problem: problem with installed package libeconf0-0.3.5+git20200203.3144b69-17.1.aarch64
Problem: problem with installed package patterns-containers-container_runtime_kubernetes-5.0-61.1.aarch64
Problem: problem with installed package patterns-containers-kubeadm-5.0-61.1.aarch64
Problem: problem with installed package patterns-containers-kubic_admin-5.0-61.1.aarch64
Problem: problem with installed package patterns-containers-kubic_loadbalancer-5.0-61.1.aarch64
Problem: problem with installed package patterns-containers-kubic_worker-5.0-61.1.aarch64

Problem: problem with installed package kubic-haproxycfg-0.10.0-44.12.aarch64
 Solution 1: install kubic-haproxycfg-0.9.1-2.4.aarch64 (with vendor change)
  obs://build.opensuse.org/home:kukuk  -->  openSUSE
 Solution 2: keep obsolete kubic-haproxycfg-0.10.0-44.12.aarch64
```

oh huh. geez oh boy...

gonna go ahead and pick the first option (vendor change) on each of these, you know I only like going upstream

let's do this

## after like an hour

here are the last lines of the update:

```
Executing %posttrans script 'coreutils-8.32-3.1.aarch64.rpm' [..
Output of coreutils-8.32-3.1.aarch64.rpm %posttrans script:
    Creating initrd: /boot/initrd-5.7.5-1-default
    dracut: Executing: /usr/bin/dracut --logfile /var/log/YaST2/mkinitrd.log --force /boot/initrd-5.7.5-1-default 5.7.5-1-default
    dracut: dracut module 'rngd' will not be installed, because command 'rngd' could not be found!
    dracut: dracut module 'dmraid' will not be installed, because command 'dmraid' could not be found!
    dracut: dracut module 'dmsquash-live-ntfs' will not be installed, because command 'ntfs-3g' could not be found!
    dracut: dracut module 'cifs' will not be installed, because command 'mount.cifs' could not be found!
    dracut: dracut module 'iscsi' will not be installed, because command 'iscsi-iname' could not be found!
    dracut: dracut module 'iscsi' will not be installed, because command 'iscsiadm' could not be found!
    dracut: dracut module 'iscsi' will not be installed, because command 'iscsid' could not be found!
    dracut: dracut module 'biosdevname' will not be installed, because command 'biosdevname' could not be found!
    dracut: dracut module 'rngd' will not be installed, because command 'rngd' could not be found!
    dracut: dracut module 'dmraid' will not be installed, because command 'dmraid' could not be found!
    dracut: dracut module 'dmsquash-live-ntfs' will not be installed, because command 'ntfs-3g' could not be found!
    dracut: dracut module 'cifs' will not be installed, because command 'mount.cifs' could not be found!
    dracut: dracut module 'iscsi' will not be installed, because command 'iscsi-iname' could not be found!
    dracut: dracut module 'iscsi' will not be installed, because command 'iscsiadm' could not be found!
    dracut: dracut module 'iscsi' will not be installed, because command 'iscsid' could not be found!
    dracut: *** Including module: bash ***
    dracut: *** Including module: systemd ***
    Failed to add dependency on unit, unit systemd-ask-password-plymouth.service does not exist.
    dracut: *** Including module: systemd-initrd ***
    dracut: *** Including module: i18n ***
    dracut: No KEYMAP configured.
    dracut: *** Including module: ignition ***
    dracut: *** Including module: ignition-microos ***
    dracut: *** Including module: network-legacy ***
    dracut: *** Including module: network ***
    dracut: *** Including module: url-lib ***
    dracut: Couldn't find SSL CA cert bundle or libnssckbi.so; HTTPS won't work.
    dracut: *** Including module: drm ***
    dracut: *** Including module: health-checker ***
    dracut: *** Including module: transactional-update ***
    dracut: *** Including module: btrfs ***
    dracut: *** Including module: kernel-modules ***
    dracut: *** Including module: kernel-modules-extra ***
    dracut: *** Including module: kernel-network-modules ***
    dracut: *** Including module: qemu ***
    dracut: *** Including module: rootfs-block ***
    dracut: *** Including module: suse-btrfs ***
    dracut: *** Including module: suse-xfs ***
    dracut: *** Including module: terminfo ***
    dracut: *** Including module: udev-rules ***
    dracut: Skipping udev rule: 40-redhat.rules
    dracut: Skipping udev rule: 50-firmware.rules
    dracut: Skipping udev rule: 50-udev.rules
    dracut: Skipping udev rule: 91-permissions.rules
    dracut: Skipping udev rule: 80-drivers-modprobe.rules
    dracut: Skipping udev rule: 70-persistent-net.rules
    dracut: *** Including module: dracut-systemd ***
    dracut: *** Including module: haveged ***
    dracut: *** Including module: usrmount ***
    dracut: *** Including module: base ***
    dracut: *** Including module: emergency-timeout ***
    dracut: *** Including module: fs-lib ***
    dracut: *** Including module: journald-conf ***
    dracut: *** Including module: lcdbootmsg ***
    dracut: *** Including module: rpi-rtc-ds3231 ***
    dracut-install: ERROR: installing '/etc/adjtime'
    dracut: FAILED: /usr/lib/dracut/dracut-install -D /var/tmp/dracut.rmXJ7E/initramfs /etc/adjtime
    dracut: *** Including module: shutdown ***
    dracut: *** Including module: suse ***
    dracut: *** Including module: suse-initrd ***
    dracut: *** Including modules done ***
    dracut: *** Installing kernel module dependencies ***
    dracut: *** Installing kernel module dependencies done ***
    dracut: *** Resolving executable dependencies ***
    dracut: *** Resolving executable dependencies done ***
    dracut: *** Hardlinking files ***
    dracut: *** Hardlinking files done ***
    dracut: *** Generating early-microcode cpio image ***
    dracut: *** Store current command line parameters ***
    dracut: Stored kernel commandline:
    dracut: rd.driver.pre=overlay
    dracut:  root=UUID=d90158e4-8c9b-4fa7-a2a8-907fc3a5b0ca rootfstype=btrfs rootflags=rw,noatime,ssd,space_cache,subvolid=281,subvol=/@/.snapshots/2/snapshot,subvol=@/.snapshots/2/snapshot
    dracut: *** Stripping files ***
    dracut: *** Stripping files done ***
    dracut: *** Creating image file '/boot/initrd-5.7.5-1-default' ***
    dracut: *** Creating initramfs image file '/boot/initrd-5.7.5-1-default' done ***

............done]
Trying to rebuild kdump initrd
Creating a new grub2 config
Generating grub configuration file ...
Found theme: /boot/grub2/themes/openSUSE/theme.txt
Found linux image: /boot/Image-5.7.5-1-default
Found initrd image: /boot/initrd-5.7.5-1-default
done

Warning: The following files were changed in the snapshot, but are shadowed by
other mounts and will not be visible to the system:
/.snapshots/2/snapshot/root/.bash_history
/.snapshots/2/snapshot/var/lib/systemd/catalog/database
/.snapshots/2/snapshot/var/lib/systemd/random-seed
/.snapshots/2/snapshot/var/lib/systemd/i18n-migrated
/.snapshots/2/snapshot/var/lib/dbus/machine-id
/.snapshots/2/snapshot/var/lock
/.snapshots/2/snapshot/var/mail

Please reboot your machine to activate the changes and avoid data loss.
New default snapshot is #2 (/.snapshots/2/snapshot).
transactional-update finished
```

done

we reboot, and I move some hardware around; this confuses it.

It looks like the "transient hostname" has overwritten our hostname again: I do another `hostnamectl set-hostname` to fix this, and am planning on exploring a full hostname solution via OpenWRT as soon as tonigh

Now that that's taken care of, I'm ready to bring this node on board for the cluster with the `kubeadm join` command I got after `kubeadm init`

running with `--v=2` shows that it gets hung on `The cluster-info ConfigMap does not yet contain a JWS signature for token ID`

okay, so, checking `kubeadm token list`, you're not supposed to wait a day to join the cluster. need to start a new token for joining rn

looking at the error on [this GitHub commit](https://github.com/kubernetes/kubeadm/issues/1477) (but not in my terminal), I run `kubeadm token create`

## hello cluster

running `kubectl get nodes`

```
studrang.nodes.403.stuartpb.com   NotReady   <none>   18s   v1.18.4
studtop.nodes.403.stuartpb.com    NotReady   master   25h   v1.18.4
```

oh wait, *not* ready

after a bit, studrang is ready... but studtop seems to find itself unreachable?

oh herp derp. same hostname problem. set it and restarted kubelet

```
studrang.nodes.403.stuartpb.com   Ready    <none>   5m56s   v1.18.4
studtop.nodes.403.stuartpb.com    Ready    master   25h     v1.18.4
```

alllloalloallo

## deep breaths

I still haven't planned out ceph properly, with entries in stubernetes-system

writing the chart to install the Ceph Operator now... looks like I'm not really going to tweak much on the operator. Added the resource records suggested at the end of [the docs](https://rook.io/docs/rook/v1.3/helm-operator.html)

looks like it really doesn't want you trying to specify nodes with a mechanism other than explicitly listing them on the cluster definition, unless they're provisioning blocks via PVC? Whatever, we can go the "explicitly naming nodes in the cluster definition" route for now. Maybe at some point I WILL go the local-pv-exposing-blocks route (and see if that might give me "portability"), but meh, for now this is good enough for me

before I start... what the heck, right now while we've only got the one node, let's plug both USB drives into it (I'm plugging them into a USB 3 hub, next to the WD My Passport which is plugged in directly). I'll let Ceph figure out the striping, but I think this'll let us have stuff where it's replicated to "3 OSDs" (since each device is a separate OSD).

I basically make sure all devices are prepped with `wipefs -a /dev/sd*` (I run it once for sda, sdb, and sdc).

## aside

https://rook.io/docs/rook/v1.3/ceph-storage.html is a nice overview from the docs

https://rook.io/docs/rook/v1.3/ceph-examples.html is misleading, from what I can tell about what things "require nodes". none of these examples feature osd-level failure domains

oh, you know what's also misleading? [the cluster CRD docs](https://rook.io/docs/rook/v1.3/ceph-cluster-crd.html#placement-configuration-settings)

> NOTE: Placement of OSD pods is controlled using the Storage Class Device Set, not the general placement configuration.

This is only true when provisioning nodes from PVCs: [nodes actually are filtered by placement](https://github.com/rook/rook/blob/6085ff32237226827fa846f59d9acbe39d795374/pkg/operator/ceph/cluster/osd/osd.go#L355)

The part about "If you use `labelSelector` for `osd` pods" confused me for a bit, too: they're talking about setting pod affinity based on the app label. This whole part of the docs sucks and could really stand improvement!

## labelling the node and getting started

anyway, gonna go ahead and add labels to the studrang node via `kubectl edit node studrang.nodes.403.stuartpb.com`

```yaml
    st8s.stuartpb.com/zone: "403"
    st8s.stuartpb.com/storage-plane: rook-ceph
```

and so that's what I'm going for when I spin up the cluster

## oh no

checking `kubectl get pods -n stubernetes-system`, the helm operator has been in a crash loop. The only thing showing up in the logs: `standard_init_linux.go:211: exec user process caused "exec format error"`

looks like this is generally caused by a thing not being multi-architecture? https://github.com/pypa/manylinux/issues/410

adding "helm flux operator" to this error I eventually land at https://github.com/fluxcd/flux/issues/1761 or rather https://github.com/fluxcd/helm-operator/issues/147

so now I'm looking at https://github.com/raspbernetes/multi-arch-images and hmm

on one hand, I feel like this can happen for any component, and so I should untaint studtop now? on the other hand...

I'll cross that bridge when I'm absolutely forced to. I roll out a new version of the stubernetes-core that points at raspbernetes' image with `helm upgrade -n stubernetes-system stubernetes-core .`

## okay, well, so now

I roll out prometheus-operator and metallb like [the last time I got to this point](04fe421b-e2d6-4a20-8b92-f23f04758d78.md) and here are the logs I end up seeing from the operator:

```
ts=2020-07-03T10:14:36.286343524Z caller=release.go:75 component=release release=prometheus-operator targetNamespace=prometheus resource=stubernetes-system:helmrelease/prometheus-operator helmVersion=v3 info="starting sync run"
ts=2020-07-03T10:14:36.287436593Z caller=release.go:75 component=release release=metallb targetNamespace=metallb-system resource=stubernetes-system:helmrelease/metallb helmVersion=v3 info="starting sync run"
ts=2020-07-03T10:15:06.311606305Z caller=release.go:81 component=release release=prometheus-operator targetNamespace=prometheus resource=stubernetes-system:helmrelease/prometheus-operator helmVersion=v3 error="failed to prepare chart for release: chart unavailable: looks like \"https://kubernetes-charts.storage.googleapis.com\" is not a valid chart repository or cannot be reached: Get \"https://kubernetes-charts.storage.googleapis.com/index.yaml\": dial tcp: i/o timeout"
ts=2020-07-03T10:15:06.320495133Z caller=release.go:81 component=release release=metallb targetNamespace=metallb-system resource=stubernetes-system:helmrelease/metallb helmVersion=v3 error="failed to prepare chart for release: chart unavailable: looks like \"https://charts.bitnami.com/bitnami\" is not a valid chart repository or cannot be reached: Get \"https://charts.bitnami.com/bitnami/index.yaml\": dial tcp: i/o timeout"
```

since these ping just fine from the host, I'm not sure what the problem is here...

I decide, screw it, I'll go ahead and edit `studtop.nodes.403.stuartpb.com` to add `st8s.stuartpb.com/zone: "403"` and remove the master NoExecute taint

now I'll go ahead and deploy with

```yaml
  nodeSelector:
    kubernetes.io/arch: amd64
```

but still the raspbernetes image, and we'll see if anything changes

it could also be that the default `50m` core is too little to do tls on ARM, but, like, yikes

## anyway

switching the helm operator to `amd64` worked

but now, once I try rolling out the rest, I still get this error:

```
  Warning  FailedReleaseSync  11s (x2 over 2m43s)  helm-operator  synchronization of release 'household-dns' in namespace 'household-system' failed: failed to prepare chart for release: could not find valid chart source configuration for release
```

okay, this weird, because I'm pretty sure I had this working before

I try switching back to the fluxcd image

no, still not working. hm.

ok, looks like the problem was we had to specify `path: /`

ok, well, household-dns is now working enough to  resolve DNS requests...

but will it resolve local apps?

## rolling out dashboard and rook-ceph

Thinking this might be the thing keeping prometheus down

```
  Warning  FailedReleaseSync  43s (x2 over 98s)  helm-operator  synchronization of release 'rook-ceph' in namespace 'rook-ceph' failed: installation failed: template: rook-ceph/templates/clusterrole.yaml:284:7: executing "rook-ceph/templates/clusterrole.yaml" at <((.Values.agent) and .Values.agent.mountSecurityMode) and ne .Values.agent.mountSecurityMode "Any">: can't give argument to non-function (.Values.agent) and .Values.agent.mountSecurityMode
```

looks like the fix for this landed [a week ago](https://github.com/rook/rook/pull/5660)

## after setting up openwrt

They're having DNS problems?

Oh, durr, because they're still trying to resolve at 192.168.0.1, and OpenWRT is at 192.168.1.1

rebooting both, doing `curl https://github.com/stuartpb.keys > /root/.ssh/authorized_keys` on studtop because I'm sick of finding the Ignition key

ugh, they're showing unqualified transient hostnames again. I'll figure this out later: doing `hostnamectl set-hostname ` to the FQDNs and restarting Kubelets until then

## ugh, the values workaround did not fix this

https://github.com/rook/rook/pull/5660#issuecomment-653540762
