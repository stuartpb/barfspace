# The Cluster Running with Pomerium 2020-10-20

I ran into some issues that I posted to GitHub in getting Pomerium up and running, but it's up now.

I rolled back my [cluster-wide move to ingress-nginx](8hs34-qrjyd-04a0f-ms2cp-y214p) in the previous iteration where I tried it, but thinking about it more, I've decided I'm going to. The reasons are manifold:

- Even though it may not route to multiple gateway instances as a load-balancing mesh by default, I don't really need it to?
- I'm liable to get more out of the kind of load-balancing I *am* likely to need (ie. failover) from a container that doesn't need to be pinned to amd64
  - it's not really worth waiting for a new Contour release
- better support of a legacy, yadda yadda yadda, I said this stuff in my original description of why I was reluctantly switching

Ultimately, the reason is that I want to use forward auth with Pomerium (which Contour doesn't really support right now), but not really for technical reasons.

## The real reason I want to enable Pomerium's forward-auth

By default, Pomerium will add all the From hosts you define Policy rules for to its one Ingress - not multiple documents per Host, but multiple hosts *within the same Ingress*.

The thing about having one Ingress for all inbound Pomerium traffic, following the default configuration, is that it makes it so all these proxied service's Hosts are also included *as part of the certificate generated by cert-manager*. In production, that'd mean that **changing the set of hosts proxied by Pomerium more than five times in a week, *by itself*, would break our HTTPS cetificate** from Let's Encrypt, due to rate limits on re-issuing certificates for the same domain.

This might be okay if Pomerium was being deployed on, like, a 1:1 basis with each service it controls auth for, but by the way we're seeking to use it, it'd make more sense to go back to handling all our hosts in Ingress objects, which can live in either their own namespace or Pomerium depending on whether or not they need to be proxied (see next section)

And, I mean, there are other ways this stuff could be worked around - like, you know, disabling the chart-provided Ingress altogether, or at least the TLS Hosts configuration, and defining it yourself at the Kustomization level - but, like, if I'm going to fight this chart, I'd rather it be on fair terms in a mutually-agreed-upon arena.

It seems like the whole idea behind having everything turn this way when one enables forward-auth is the idea that "forward-ath" mode is meant to work in conjunction with the Operator, and is thus sort of a Bring-Your-Own-Ingress mode by definition.

## On defining Ingress outside of Helm

Using mostly Ingress annotations to set up the Pomerium auth would let me switch my Ingress definitions back to annotations within patches to the Helm values...

But, like, nah - a significant part of why I'm making this switch is that, honestly, it's less of a pain in the ass, especially the way Kustomize is currently constituted (or at least "currently" in the sense of "the Components spec seems a bit sketchy support-wise at the moment"), to maintain discrete resources in a Kustomization than it is to maintain patches on a base.

Considering how many stakeholders have to work together to make Ingresses work together (cert-manager, external-dns, Envoy and Contour/Ambassador or whoever, potentially Pomerium...), it makes a lot of sense to keep responsibility for them within the context of your own unique setup, and out of the hands of your upstream Helm chart maintainers - just look how many uncomfortable assumptions there are about what's appropriate for a default TLS configuration in the Pomerium chart.

## Why I switched back to Contour, originally

I initially thought forward auth wasn't that great, since advanced functionality (like injecting headers for Grafana) requires proxing anyway (or, you know, it does if all you're working with is plain Ingress objects/servers). Like, all the "EXPERIMENTAL" around it, and the lack of support in Contour, made me decide, "nah, it's not worth it".

And yeah, for getting to know it the old way, figure out what problems I'd run into one class of malfunction at a time (ie. things that I know used to work on Contour wouldn't also potentially be having trouble because of my Nginx configuration), I wanted to [get my feet wet trying it this proxy-only old way](gyyzw-yaxmy-8f8bs-f97jh-ma3mq), but yeah, I'm ready to swap in the nginx ingress.

But yeah, it's still enough for a bunch of services, and it's lighter weight in that case, and the nginx ingress controller is sort of lighter-weight in general. And the services you still need to proxy - if you've got forward-auth defined, you just define the proxy document for those services by themselves

## on revisiting Contour

If Contour ever conclusively supports forward auth and arm64/multiarch, I *might* switch back, but at this point I've decided, that'll be the [hysteresis](a5a42-sqvhc-4kb1v-xhtmf-fqyhd) for any change back.

